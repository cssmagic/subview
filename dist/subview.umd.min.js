!function(t,i){"function"==typeof define&&define.amd?define(["jquery"],i):"object"==typeof exports?module.exports=i():t.subview=i()}(this,function(){var t=function(t){"use strict";var i,s=t.history||{};return i={CLS:"subview",CLS_ROOT:"subview-root",CLS_IN:"subview-in",CLS_OUT:"subview-out",CLS_READY:"subview-ready",EV_BFR_SHOW:"subviewBeforeShow",EV_AFT_SHOW:"subviewAfterShow",EV_BFR_HIDE:"subviewBeforeHide",EV_AFT_HIDE:"subviewAfterHide",ACT_SWITCH_TO:"subview-switch-to",ACT_SWITCH_BACK:"subview-switch-back",STATE_TYPE:"subview",_stack:[],init:function(){this._setup(),this._bind()},_setup:function(){this._update()},_update:function(){if(this.$views=$("."+this.CLS),this.$views.length>1){var t=$("."+this.CLS_ROOT);t.length||(t=this.$views.first().addClass(this.CLS_ROOT)),this.$rootView=t,t.addClass(this.CLS_IN),this.$views.not(t).addClass(this.CLS_READY),this._stack.length<1&&this._stack.push(t[0])}},_initState:function(){var t={type:this.STATE_TYPE,title:document.title};setTimeout(function(){s.replaceState(t,null,null),console.log("[Subview] [replaceState] time: "+Date.now()+", state: "+JSON.stringify(s.state))}.bind(this),0)},_bind:function(){var i=$(t);i.on("load",function(){this._initState()}.bind(this)).on("popstate",function(t){this._handleState()}.bind(this))},_getHashFromLink:function(t){var i=t.href.split("#")[1]||"";return i?"#"+i:i},_pushState:function(t,i){t.id||(t.id="subview-id"+Date.now());var e=i.title||null,n=i.url||null,a={type:this.STATE_TYPE,title:e,target:"#"+t.id};s.pushState(a,null,n),e&&(document.title=e)},_slideIn:function(i,s){var e=this._stack,n=$(i);if(!n.hasClass(this.CLS))return!1;var a=e[e.length-1],r=$(a);a._uiScrollPosition=t.pageYOffset,r.trigger(this.EV_BFR_HIDE),r.removeClass(this.CLS_IN).addClass(this.CLS_OUT),r.trigger(this.EV_AFT_HIDE),t.scrollTo(0,0),n.trigger(this.EV_BFR_SHOW),n.removeClass(this.CLS_READY).addClass(this.CLS_IN),n.trigger(this.EV_AFT_SHOW),e.push(n[0]),s&&this._pushState(i,s)},_slideBack:function(){var i=this._stack,s=i.length;if(2>s)return!1;var e=$(i.pop());e.trigger(this.EV_BFR_HIDE),e.removeClass(this.CLS_IN).addClass(this.CLS_READY),e.trigger(this.EV_AFT_HIDE);var n=i[i.length-1],a=$(n);a.trigger(this.EV_BFR_SHOW),a.css("visibility","hidden").removeClass(this.CLS_OUT).addClass(this.CLS_IN),a.trigger(this.EV_AFT_SHOW),setTimeout(function(){t.scrollTo(0,n._uiScrollPosition),a.css("visibility","visible"),n._uiScrollPosition=null},0)},_adjustStack:function(t){var i=this._stack;if(t+2===i.length)return!1;var s=i.slice(t+2);i=i.slice(0,t+2),s.forEach(function(t){var i=$(t);i.removeClass(this.CLS_OUT+" "+this.CLS_IN).addClass(this.CLS_READY)},this),$(i[i.length-1]).removeClass(this.CLS_OUT).addClass(this.CLS_IN),this._stack=i},_handleState:function(){var t=s.state||{};if(t.type!==this.STATE_TYPE)return!1;var i=t.target,e=i?$(i):this.$rootView;return e.length?(this._switchTo(e[0]),void(t.title&&(document.title=t.title))):!1},_switchTo:function(t,i){var s=this._stack,e=s.indexOf(t);if(0>e)this._slideIn(t,i);else{if(e+1===s.length)return!1;e+1<s.length&&(this._adjustStack(e),this._slideBack())}},refresh:function(){this._update()},switchTo:function(t,i){var s=$(t).first();return s.hasClass(this.CLS)?(t=s[0],i&&$.isPlainObject(i)||(i={}),$.isFunction(i.beforeShow)&&s.one(this.EV_BFR_SHOW,i.beforeShow),$.isFunction(i.afterShow)&&s.one(this.EV_AFT_SHOW,i.afterShow),void this._switchTo(t,i)):!1},switchBack:function(){var t=s.state||{};t.type===this.STATE_TYPE?s.back():this._slideBack()},updateState:function(t){if(!$.isPlainObject(t))return!1;var i=t.title||null,e=t.url||null;if(!e&&!i)return!1;var n=s.state,a={type:this.STATE_TYPE,title:i||n.title,target:n.target};s.replaceState(a,null,e),i&&(document.title=i)},exportActions:function(){var t={},i=this;return t[this.ACT_SWITCH_TO]=function(t){var s=this,e=$(s),n=e.data("target"),a=$.trim(s.getAttribute("href"))||null;n||(n=i._getHashFromLink(s),a=null);var r=e.data("title")||s.title||null,o={url:a,title:r};i.switchTo(n,o)},t[this.ACT_SWITCH_BACK]=function(){i.switchBack()},t},debug:function(){var t=$("."+this.CLS);console.log("===== start =====");var i=this;t.each(function(){var t=this;console.log(t,": scroll position=",t._uiScrollPosition,", in stack =",i._stack.indexOf(t))}),console.log("===== end =====")}}}(window);return t});