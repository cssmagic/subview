!function(t,i){"function"==typeof define&&define.amd?define(["jquery"],i):"object"==typeof exports?module.exports=i(require("jquery")):t.subview=i(t.jQuery||t.Zepto||t.$)}(this,function(t){var i=function(i){"use strict";var s,e=i.history||{};return s={CLS:"subview",CLS_ROOT:"subview-root",CLS_IN:"subview-in",CLS_OUT:"subview-out",CLS_READY:"subview-ready",EV_BFR_SHOW:"subviewBeforeShow",EV_AFT_SHOW:"subviewAfterShow",EV_BFR_HIDE:"subviewBeforeHide",EV_AFT_HIDE:"subviewAfterHide",ACT_SWITCH_TO:"subview-switch-to",ACT_SWITCH_BACK:"subview-switch-back",STATE_TYPE:"subview",_stack:[],init:function(){this._setup(),this._bind()},_setup:function(){this._update()},_update:function(){if(this.$views=t("."+this.CLS),this.$views.length>1){var i=t("."+this.CLS_ROOT);i.length||(i=this.$views.first().addClass(this.CLS_ROOT)),this.$rootView=i,i.addClass(this.CLS_IN),this.$views.not(i).addClass(this.CLS_READY),this._stack.length<1&&this._stack.push(i[0])}},_initState:function(){var t={type:this.STATE_TYPE,title:document.title};setTimeout(function(){e.replaceState(t,null,null)}.bind(this),0)},_bind:function(){var s=t(i);s.on("load",function(){this._initState()}.bind(this)).on("popstate",function(t){this._handleState()}.bind(this))},_getHashFromLink:function(t){var i=t.href.split("#")[1]||"";return i?"#"+i:i},_pushState:function(t,i){t.id||(t.id="subview-id"+Date.now());var s=i.title||null,n=i.url||null,r={type:this.STATE_TYPE,title:s,target:"#"+t.id};e.pushState(r,null,n),s&&(document.title=s)},_slideIn:function(s,e){var n=this._stack,r=t(s);if(!r.hasClass(this.CLS))return!1;var a=n[n.length-1],o=t(a);a._uiScrollPosition=i.pageYOffset,o.trigger(this.EV_BFR_HIDE),o.removeClass(this.CLS_IN).addClass(this.CLS_OUT),o.trigger(this.EV_AFT_HIDE),i.scrollTo(0,0),r.trigger(this.EV_BFR_SHOW),r.removeClass(this.CLS_READY).addClass(this.CLS_IN),r.trigger(this.EV_AFT_SHOW),n.push(r[0]),e&&this._pushState(s,e)},_slideBack:function(){var s=this._stack,e=s.length;if(2>e)return!1;var n=t(s.pop());n.trigger(this.EV_BFR_HIDE),n.removeClass(this.CLS_IN).addClass(this.CLS_READY),n.trigger(this.EV_AFT_HIDE);var r=s[s.length-1],a=t(r);a.trigger(this.EV_BFR_SHOW),a.css("visibility","hidden").removeClass(this.CLS_OUT).addClass(this.CLS_IN),a.trigger(this.EV_AFT_SHOW),setTimeout(function(){i.scrollTo(0,r._uiScrollPosition),a.css("visibility","visible"),r._uiScrollPosition=null},0)},_adjustStack:function(i){var s=this._stack;if(i+2===s.length)return!1;var e=s.slice(i+2);s=s.slice(0,i+2),e.forEach(function(i){var s=t(i);s.removeClass(this.CLS_OUT+" "+this.CLS_IN).addClass(this.CLS_READY)},this),t(s[s.length-1]).removeClass(this.CLS_OUT).addClass(this.CLS_IN),this._stack=s},_handleState:function(){var i=e.state||{};if(i.type!==this.STATE_TYPE)return!1;var s=i.target,n=s?t(s):this.$rootView;return n.length?(this._switchTo(n[0]),void(i.title&&(document.title=i.title))):!1},_switchTo:function(t,i){var s=this._stack,e=s.indexOf(t);if(0>e)this._slideIn(t,i);else{if(e+1===s.length)return!1;e+1<s.length&&(this._adjustStack(e),this._slideBack())}},refresh:function(){this._update()},switchTo:function(i,s){var e=t(i).first();return e.hasClass(this.CLS)?(i=e[0],s&&t.isPlainObject(s)||(s={}),t.isFunction(s.beforeShow)&&e.one(this.EV_BFR_SHOW,s.beforeShow),t.isFunction(s.afterShow)&&e.one(this.EV_AFT_SHOW,s.afterShow),void this._switchTo(i,s)):!1},switchBack:function(){var t=e.state||{};t.type===this.STATE_TYPE?e.back():this._slideBack()},updateState:function(i){if(!t.isPlainObject(i))return!1;var s=i.title||null,n=i.url||null;if(!n&&!s)return!1;var r=e.state,a={type:this.STATE_TYPE,title:s||r.title,target:r.target};e.replaceState(a,null,n),s&&(document.title=s)},exportActions:function(){var i={},s=this;return i[this.ACT_SWITCH_TO]=function(i){var e=this,n=t(e),r=n.data("target"),a=t.trim(e.getAttribute("href"))||null;r||(r=s._getHashFromLink(e),a=null);var o=n.data("title")||e.title||null,h={url:a,title:o};s.switchTo(r,h)},i[this.ACT_SWITCH_BACK]=function(){s.switchBack()},i},debug:function(){var i=t("."+this.CLS);console.log("===== start =====");var s=this;i.each(function(){var t=this;console.log(t,": scroll position=",t._uiScrollPosition,", in stack =",s._stack.indexOf(t))}),console.log("===== end =====")}}}(window);return i});